
import json
from PIL import Image
import matplotlib.pyplot as plt
from tqdm import tqdm
import matplotlib.pyplot as plt
import numpy as np
import os
import torch

import inflect
p = inflect.engine()
import argparse

parser = argparse.ArgumentParser(description='Depth order generation')
parser.add_argument('--semantic-seg', type=str, help='Path to the semantic segmentation images', default="playground/data/eval/gqa/data/seg_images/semantic")
parser.add_argument('--output', type=str, help='Path to the output json', default="playground/data/eval/gqa/data/seg_images")

args = parser.parse_args()

categories = [{'supercategory': 'person', 'isthing': 1, 'id': 1, 'name': 'person'}, {'supercategory': 'vehicle', 'isthing': 1, 'id': 2, 'name': 'bicycle'}, {'supercategory': 'vehicle', 'isthing': 1, 'id': 3, 'name': 'car'}, {'supercategory': 'vehicle', 'isthing': 1, 'id': 4, 'name': 'motorcycle'}, {'supercategory': 'vehicle', 'isthing': 1, 'id': 5, 'name': 'airplane'}, {'supercategory': 'vehicle', 'isthing': 1, 'id': 6, 'name': 'bus'}, {'supercategory': 'vehicle', 'isthing': 1, 'id': 7, 'name': 'train'}, {'supercategory': 'vehicle', 'isthing': 1, 'id': 8, 'name': 'truck'}, {'supercategory': 'vehicle', 'isthing': 1, 'id': 9, 'name': 'boat'}, {'supercategory': 'outdoor', 'isthing': 1, 'id': 10, 'name': 'traffic light'}, {'supercategory': 'outdoor', 'isthing': 1, 'id': 11, 'name': 'fire hydrant'}, {'supercategory': 'outdoor', 'isthing': 1, 'id': 13, 'name': 'stop sign'}, {'supercategory': 'outdoor', 'isthing': 1, 'id': 14, 'name': 'parking meter'}, {'supercategory': 'outdoor', 'isthing': 1, 'id': 15, 'name': 'bench'}, {'supercategory': 'animal', 'isthing': 1, 'id': 16, 'name': 'bird'}, {'supercategory': 'animal', 'isthing': 1, 'id': 17, 'name': 'cat'}, {'supercategory': 'animal', 'isthing': 1, 'id': 18, 'name': 'dog'}, {'supercategory': 'animal', 'isthing': 1, 'id': 19, 'name': 'horse'}, {'supercategory': 'animal', 'isthing': 1, 'id': 20, 'name': 'sheep'}, {'supercategory': 'animal', 'isthing': 1, 'id': 21, 'name': 'cow'}, {'supercategory': 'animal', 'isthing': 1, 'id': 22, 'name': 'elephant'}, {'supercategory': 'animal', 'isthing': 1, 'id': 23, 'name': 'bear'}, {'supercategory': 'animal', 'isthing': 1, 'id': 24, 'name': 'zebra'}, {'supercategory': 'animal', 'isthing': 1, 'id': 25, 'name': 'giraffe'}, {'supercategory': 'accessory', 'isthing': 1, 'id': 27, 'name': 'backpack'}, {'supercategory': 'accessory', 'isthing': 1, 'id': 28, 'name': 'umbrella'}, {'supercategory': 'accessory', 'isthing': 1, 'id': 31, 'name': 'handbag'}, {'supercategory': 'accessory', 'isthing': 1, 'id': 32, 'name': 'tie'}, {'supercategory': 'accessory', 'isthing': 1, 'id': 33, 'name': 'suitcase'}, {'supercategory': 'sports', 'isthing': 1, 'id': 34, 'name': 'frisbee'}, {'supercategory': 'sports', 'isthing': 1, 'id': 35, 'name': 'skis'}, {'supercategory': 'sports', 'isthing': 1, 'id': 36, 'name': 'snowboard'}, {'supercategory': 'sports', 'isthing': 1, 'id': 37, 'name': 'sports ball'}, {'supercategory': 'sports', 'isthing': 1, 'id': 38, 'name': 'kite'}, {'supercategory': 'sports', 'isthing': 1, 'id': 39, 'name': 'baseball bat'}, {'supercategory': 'sports', 'isthing': 1, 'id': 40, 'name': 'baseball glove'}, {'supercategory': 'sports', 'isthing': 1, 'id': 41, 'name': 'skateboard'}, {'supercategory': 'sports', 'isthing': 1, 'id': 42, 'name': 'surfboard'}, {'supercategory': 'sports', 'isthing': 1, 'id': 43, 'name': 'tennis racket'}, {'supercategory': 'kitchen', 'isthing': 1, 'id': 44, 'name': 'bottle'}, {'supercategory': 'kitchen', 'isthing': 1, 'id': 46, 'name': 'wine glass'}, {'supercategory': 'kitchen', 'isthing': 1, 'id': 47, 'name': 'cup'}, {'supercategory': 'kitchen', 'isthing': 1, 'id': 48, 'name': 'fork'}, {'supercategory': 'kitchen', 'isthing': 1, 'id': 49, 'name': 'knife'}, {'supercategory': 'kitchen', 'isthing': 1, 'id': 50, 'name': 'spoon'}, {'supercategory': 'kitchen', 'isthing': 1, 'id': 51, 'name': 'bowl'}, {'supercategory': 'food', 'isthing': 1, 'id': 52, 'name': 'banana'}, {'supercategory': 'food', 'isthing': 1, 'id': 53, 'name': 'apple'}, {'supercategory': 'food', 'isthing': 1, 'id': 54, 'name': 'sandwich'}, {'supercategory': 'food', 'isthing': 1, 'id': 55, 'name': 'orange'}, {'supercategory': 'food', 'isthing': 1, 'id': 56, 'name': 'broccoli'}, {'supercategory': 'food', 'isthing': 1, 'id': 57, 'name': 'carrot'}, {'supercategory': 'food', 'isthing': 1, 'id': 58, 'name': 'hot dog'}, {'supercategory': 'food', 'isthing': 1, 'id': 59, 'name': 'pizza'}, {'supercategory': 'food', 'isthing': 1, 'id': 60, 'name': 'donut'}, {'supercategory': 'food', 'isthing': 1, 'id': 61, 'name': 'cake'}, {'supercategory': 'furniture', 'isthing': 1, 'id': 62, 'name': 'chair'}, {'supercategory': 'furniture', 'isthing': 1, 'id': 63, 'name': 'couch'}, {'supercategory': 'furniture', 'isthing': 1, 'id': 64, 'name': 'potted plant'}, {'supercategory': 'furniture', 'isthing': 1, 'id': 65, 'name': 'bed'}, {'supercategory': 'furniture', 'isthing': 1, 'id': 67, 'name': 'dining table'}, {'supercategory': 'furniture', 'isthing': 1, 'id': 70, 'name': 'toilet'}, {'supercategory': 'electronic', 'isthing': 1, 'id': 72, 'name': 'tv'}, {'supercategory': 'electronic', 'isthing': 1, 'id': 73, 'name': 'laptop'}, {'supercategory': 'electronic', 'isthing': 1, 'id': 74, 'name': 'mouse'}, {'supercategory': 'electronic', 'isthing': 1, 'id': 75, 'name': 'remote'}, {'supercategory': 'electronic', 'isthing': 1, 'id': 76, 'name': 'keyboard'}, {'supercategory': 'electronic', 'isthing': 1, 'id': 77, 'name': 'cell phone'}, {'supercategory': 'appliance', 'isthing': 1, 'id': 78, 'name': 'microwave'}, {'supercategory': 'appliance', 'isthing': 1, 'id': 79, 'name': 'oven'}, {'supercategory': 'appliance', 'isthing': 1, 'id': 80, 'name': 'toaster'}, {'supercategory': 'appliance', 'isthing': 1, 'id': 81, 'name': 'sink'}, {'supercategory': 'appliance', 'isthing': 1, 'id': 82, 'name': 'refrigerator'}, {'supercategory': 'indoor', 'isthing': 1, 'id': 84, 'name': 'book'}, {'supercategory': 'indoor', 'isthing': 1, 'id': 85, 'name': 'clock'}, {'supercategory': 'indoor', 'isthing': 1, 'id': 86, 'name': 'vase'}, {'supercategory': 'indoor', 'isthing': 1, 'id': 87, 'name': 'scissors'}, {'supercategory': 'indoor', 'isthing': 1, 'id': 88, 'name': 'teddy bear'}, {'supercategory': 'indoor', 'isthing': 1, 'id': 89, 'name': 'hair drier'}, {'supercategory': 'indoor', 'isthing': 1, 'id': 90, 'name': 'toothbrush'}, {'supercategory': 'textile', 'id': 92, 'name': 'banner', 'isthing': 0}, {'supercategory': 'textile', 'id': 93, 'name': 'blanket', 'isthing': 0}, {'supercategory': 'plant', 'id': 94, 'name': 'branch', 'isthing': 0}, {'supercategory': 'building', 'id': 95, 'name': 'bridge', 'isthing': 0}, {'supercategory': 'building', 'id': 96, 'name': 'building-other', 'isthing': 0}, {'supercategory': 'plant', 'id': 97, 'name': 'bush', 'isthing': 0}, {'supercategory': 'furniture-stuff', 'id': 98, 'name': 'cabinet', 'isthing': 0}, {'supercategory': 'structural', 'id': 99, 'name': 'cage', 'isthing': 0}, {'supercategory': 'raw-material', 'id': 100, 'name': 'cardboard', 'isthing': 0}, {'supercategory': 'floor', 'id': 101, 'name': 'carpet', 'isthing': 0}, {'supercategory': 'ceiling', 'id': 102, 'name': 'ceiling-other', 'isthing': 0}, {'supercategory': 'ceiling', 'id': 103, 'name': 'ceiling-tile', 'isthing': 0}, {'supercategory': 'textile', 'id': 104, 'name': 'cloth', 'isthing': 0}, {'supercategory': 'textile', 'id': 105, 'name': 'clothes', 'isthing': 0}, {'supercategory': 'sky', 'id': 106, 'name': 'clouds', 'isthing': 0}, {'supercategory': 'furniture-stuff', 'id': 107, 'name': 'counter', 'isthing': 0}, {'supercategory': 'furniture-stuff', 'id': 108, 'name': 'cupboard', 'isthing': 0}, {'supercategory': 'textile', 'id': 109, 'name': 'curtain', 'isthing': 0}, {'supercategory': 'furniture-stuff', 'id': 110, 'name': 'desk-stuff', 'isthing': 0}, {'supercategory': 'ground', 'id': 111, 'name': 'dirt', 'isthing': 0}, {'supercategory': 'furniture-stuff', 'id': 112, 'name': 'door-stuff', 'isthing': 0}, {'supercategory': 'structural', 'id': 113, 'name': 'fence', 'isthing': 0}, {'supercategory': 'floor', 'id': 114, 'name': 'floor-marble', 'isthing': 0}, {'supercategory': 'floor', 'id': 115, 'name': 'floor-other', 'isthing': 0}, {'supercategory': 'floor', 'id': 116, 'name': 'floor-stone', 'isthing': 0}, {'supercategory': 'floor', 'id': 117, 'name': 'floor-tile', 'isthing': 0}, {'supercategory': 'floor', 'id': 118, 'name': 'floor-wood', 'isthing': 0}, {'supercategory': 'plant', 'id': 119, 'name': 'flower', 'isthing': 0}, {'supercategory': 'water', 'id': 120, 'name': 'fog', 'isthing': 0}, {'supercategory': 'food-stuff', 'id': 121, 'name': 'food-other', 'isthing': 0}, {'supercategory': 'food-stuff', 'id': 122, 'name': 'fruit', 'isthing': 0}, {'supercategory': 'furniture-stuff', 'id': 123, 'name': 'furniture-other', 'isthing': 0}, {'supercategory': 'plant', 'id': 124, 'name': 'grass', 'isthing': 0}, {'supercategory': 'ground', 'id': 125, 'name': 'gravel', 'isthing': 0}, {'supercategory': 'ground', 'id': 126, 'name': 'ground-other', 'isthing': 0}, {'supercategory': 'solid', 'id': 127, 'name': 'hill', 'isthing': 0}, {'supercategory': 'building', 'id': 128, 'name': 'house', 'isthing': 0}, {'supercategory': 'plant', 'id': 129, 'name': 'leaves', 'isthing': 0}, {'supercategory': 'furniture-stuff', 'id': 130, 'name': 'light', 'isthing': 0}, {'supercategory': 'textile', 'id': 131, 'name': 'mat', 'isthing': 0}, {'supercategory': 'raw-material', 'id': 132, 'name': 'metal', 'isthing': 0}, {'supercategory': 'furniture-stuff', 'id': 133, 'name': 'mirror-stuff', 'isthing': 0}, {'supercategory': 'plant', 'id': 134, 'name': 'moss', 'isthing': 0}, {'supercategory': 'solid', 'id': 135, 'name': 'mountain', 'isthing': 0}, {'supercategory': 'ground', 'id': 136, 'name': 'mud', 'isthing': 0}, {'supercategory': 'textile', 'id': 137, 'name': 'napkin', 'isthing': 0}, {'supercategory': 'structural', 'id': 138, 'name': 'net', 'isthing': 0}, {'supercategory': 'raw-material', 'id': 139, 'name': 'paper', 'isthing': 0}, {'supercategory': 'ground', 'id': 140, 'name': 'pavement', 'isthing': 0}, {'supercategory': 'textile', 'id': 141, 'name': 'pillow', 'isthing': 0}, {'supercategory': 'plant', 'id': 142, 'name': 'plant-other', 'isthing': 0}, {'supercategory': 'raw-material', 'id': 143, 'name': 'plastic', 'isthing': 0}, {'supercategory': 'ground', 'id': 144, 'name': 'platform', 'isthing': 0}, {'supercategory': 'ground', 'id': 145, 'name': 'playingfield', 'isthing': 0}, {'supercategory': 'structural', 'id': 146, 'name': 'railing', 'isthing': 0}, {'supercategory': 'ground', 'id': 147, 'name': 'railroad', 'isthing': 0}, {'supercategory': 'water', 'id': 148, 'name': 'river', 'isthing': 0}, {'supercategory': 'ground', 'id': 149, 'name': 'road', 'isthing': 0}, {'supercategory': 'solid', 'id': 150, 'name': 'rock', 'isthing': 0}, {'supercategory': 'building', 'id': 151, 'name': 'roof', 'isthing': 0}, {'supercategory': 'textile', 'id': 152, 'name': 'rug', 'isthing': 0}, {'supercategory': 'food-stuff', 'id': 153, 'name': 'salad', 'isthing': 0}, {'supercategory': 'ground', 'id': 154, 'name': 'sand', 'isthing': 0}, {'supercategory': 'water', 'id': 155, 'name': 'sea', 'isthing': 0}, {'supercategory': 'furniture-stuff', 'id': 156, 'name': 'shelf', 'isthing': 0}, {'supercategory': 'sky', 'id': 157, 'name': 'sky-other', 'isthing': 0}, {'supercategory': 'building', 'id': 158, 'name': 'skyscraper', 'isthing': 0}, {'supercategory': 'ground', 'id': 159, 'name': 'snow', 'isthing': 0}, {'supercategory': 'solid', 'id': 160, 'name': 'solid-other', 'isthing': 0}, {'supercategory': 'furniture-stuff', 'id': 161, 'name': 'stairs', 'isthing': 0}, {'supercategory': 'solid', 'id': 162, 'name': 'stone', 'isthing': 0}, {'supercategory': 'plant', 'id': 163, 'name': 'straw', 'isthing': 0}, {'supercategory': 'structural', 'id': 164, 'name': 'structural-other', 'isthing': 0}, {'supercategory': 'furniture-stuff', 'id': 165, 'name': 'table', 'isthing': 0}, {'supercategory': 'building', 'id': 166, 'name': 'tent', 'isthing': 0}, {'supercategory': 'textile', 'id': 167, 'name': 'textile-other', 'isthing': 0}, {'supercategory': 'textile', 'id': 168, 'name': 'towel', 'isthing': 0}, {'supercategory': 'plant', 'id': 169, 'name': 'tree', 'isthing': 0}, {'supercategory': 'food-stuff', 'id': 170, 'name': 'vegetable', 'isthing': 0}, {'supercategory': 'wall', 'id': 171, 'name': 'wall-brick', 'isthing': 0}, {'supercategory': 'wall', 'id': 172, 'name': 'wall-concrete', 'isthing': 0}, {'supercategory': 'wall', 'id': 173, 'name': 'wall-other', 'isthing': 0}, {'supercategory': 'wall', 'id': 174, 'name': 'wall-panel', 'isthing': 0}, {'supercategory': 'wall', 'id': 175, 'name': 'wall-stone', 'isthing': 0}, {'supercategory': 'wall', 'id': 176, 'name': 'wall-tile', 'isthing': 0}, {'supercategory': 'wall', 'id': 177, 'name': 'wall-wood', 'isthing': 0}, {'supercategory': 'water', 'id': 178, 'name': 'water-other', 'isthing': 0}, {'supercategory': 'water', 'id': 179, 'name': 'waterdrops', 'isthing': 0}, {'supercategory': 'window', 'id': 180, 'name': 'window-blind', 'isthing': 0}, {'supercategory': 'window', 'id': 181, 'name': 'window-other', 'isthing': 0}, {'supercategory': 'solid', 'id': 182, 'name': 'wood', 'isthing': 0}]

categories_id = {cat["id"]: i for i, cat in enumerate(categories)}

segment_json = {}

if not os.path.exists(args.output):
    os.makedirs(args.output)

with open(os.path.join(args.output, f"semantic.txt"), "w") as f:
    f.write("")

image_list = os.listdir(args.semantic_seg)
for image in tqdm(image_list):
    semantic_path = os.path.join(args.semantic_seg, image)
    semantic_mask = np.array(Image.open(semantic_path))

    image_path = image.replace("png", "jpg")
    segment_json[image_path] = []

    class_ids = np.unique(semantic_mask)
    # remove 0 and 255
    class_ids = class_ids[(class_ids != 0) & (class_ids != 255)]

    if len(class_ids) > 0:
        seg_answer = "The objects present in the image are: "
        for cat in class_ids:
            binary_mask = semantic_mask == cat

            from pycocotools import mask
            binary_mask_encoded = mask.encode(np.asfortranarray(binary_mask.astype(np.uint8)))
            bbox = mask.toBbox(binary_mask_encoded)

            category = categories[categories_id[cat + 1]]
            segment_json[image_path].append({"category": category["name"].split("-")[0],
                                        "is_thing": category["isthing"],
                                        "bbox": [int(bbox[0]), int(bbox[1]), int(bbox[2]), int(bbox[3])]})
            seg_answer += category["name"].split("-")[0] + ", "
        seg_answer = seg_answer[:-2] + "."
    else:
        seg_answer = "There are no detectable objects in the image"

    with open(os.path.join(args.output, f"semantic.txt"), "a") as f:
        f.write("<IMG>" + image_path + "<IMG>" + seg_answer + "\n")